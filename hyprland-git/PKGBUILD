pkgbase=hyprland-git
pkgname=(hyprland-git hyprland-git-devel)
pkgver=v0.20.1beta+r0+gaf4b970
pkgrel=1
pkgdesc="Dynamic tiling Wayland compositor that doesn't sacrifice on its looks"
arch=("x86_64")
url="https://github.com/hyprwm/Hyprland"
license=('BSD')
depends=(mesa xcb-util xcb-util-keysyms libinput libxcomposite xorg-xinput libxkbcommon pango xcb-util-renderutil xcb-util-wm seatd xcb-util-errors systemd)
makedepends=(git cmake meson vulkan-headers glslang systemd wayland-protocols xorg-xwayland jq)
source=("${pkgname%-git}::git+https://github.com/hyprwm/Hyprland.git"
		"git+https://github.com/hyprwm/hyprland-protocols.git"
		"git+https://gitlab.freedesktop.org/wlroots/wlroots.git")
sha256sums=('SKIP'
            'SKIP'
            'SKIP')

pkgver() {
	cd "${pkgname%-git}"
  	git describe --tags --long | sed 's/[^-]*-g/r&/;s/-/+/g'
}

_pick() {
  local p="$1" f d; shift
  for f; do
    d="$srcdir/$p/${f#$pkgdir/}"
    mkdir -p "$(dirname "$d")"
    mv "$f" "$d"
    rmdir -p --ignore-fail-on-non-empty "$(dirname "$f")"
  done
}

prepare() {
	cd "${pkgname%-git}"
	git submodule init
	git config submodule.subprojects/wlroots.url "$srcdir/wlroots"
	git config submodule.subprojects/hyprland-protocols.url "$srcdir/hyprland-protocols"
	git -c protocol.file.allow=always submodule update
}

build() {
	cd "${pkgname%-git}"
	arch-meson build
	meson compile -C build
}

package_hyprland-git() {
	cd "${pkgname%-git}"
	meson install -C build --destdir "$pkgdir"
	(
		cd "$pkgdir"
		_pick devel usr/include
		_pick devel usr/lib
	)
	install -Dm644 LICENSE -t "$pkgdir/usr/share/licenses/hyprland-git"

}

package_hyprland-git-devel() {
	pkgdesc+=" - development files"
	depends=(hyprland)
	provides=(wlroots)
	conflicts=(wlroots)

	mv devel/* "$pkgdir"
}
